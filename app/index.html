<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Detection with TensorFlow.js</title>
    <script
            src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
            crossorigin="anonymous"
            type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script> <!-- Include TensorFlow.js -->
</head>
<body>
<h1>Face Detection from Video Stream</h1>

<video id="video" width="640" height="480" autoplay playsinline></video>
<h2>Detected Face</h2>
<canvas id="faceCanvas" style="border: 1px solid black; display: none;"></canvas>
<img id="faceImage" alt="Detected Face" style="border: 1px solid black; display: block;"/>

<p>
    Prediction With Sunglasses:
    <span id="predictionWithSunglasses"></span>
</p>

<p>
    Prediction Without Sunglasses:
    <span id="predictionWithoutSunglasses"></span>
</p>

<script type="module">
    import {FilesetResolver, FaceDetector} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js';

    async function setupCamera() {
        const video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        return new Promise((resolve) => {
            video.onloadedmetadata = () => {
                resolve(video);
            };
        });
    }

    async function runFaceDetection() {
        const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
        );

        const faceDetector = await FaceDetector.createFromOptions(
            vision,
            {
                baseOptions: {
                    modelAssetPath: "shared/models/blaze_face_short_range.tflite"
                },
                runningMode: 'VIDEO'
            }
        );

        const video = await setupCamera();
        video.play();

        const faceCanvas = document.getElementById('faceCanvas');
        const faceCtx = faceCanvas.getContext('2d');

        const model = await tf.loadLayersModel('shared/models/sunglasses/model.json');

        async function detectFace() {
            // Process each video frame for face detection
            const detections = await faceDetector.detectForVideo(video, performance.now());

            if (detections && detections.detections.length > 0) {
                const face = detections.detections[0];

                const padding = -20;
                const originX = Math.max(face.boundingBox.originX - padding, 0);
                const originY = Math.max(face.boundingBox.originY - padding, 0);
                const width = Math.min(face.boundingBox.width + 2 * padding, video.videoWidth - originX);
                const height = Math.min(face.boundingBox.height + 2 * padding, video.videoHeight - originY);

                faceCanvas.width = width;
                faceCanvas.height = height;

                faceCtx.drawImage(
                    video,
                    originX, originY, width, height,
                    0, 0, width, height
                );

                // Display the detected face in an image element
                const faceImage = document.getElementById('faceImage');
                faceImage.src = faceCanvas.toDataURL();

                // Prepare the image for sunglasses detection
                const tensor = tf.browser.fromPixels(faceCanvas);
                const resizedTensor = tf.image.resizeBilinear(tensor, [224, 224]);
                const normalizedTensor = resizedTensor.toFloat().div(tf.scalar(255));
                const batchedTensor = normalizedTensor.expandDims(0);

                const predictions = await model.predict(batchedTensor);
                const predictionsArray = predictions.arraySync();

                document.getElementById('predictionWithSunglasses').textContent = predictionsArray[0][0];
                document.getElementById('predictionWithoutSunglasses').textContent = predictionsArray[0][1];

                tensor.dispose();
                resizedTensor.dispose();
                normalizedTensor.dispose();
                batchedTensor.dispose();
                predictions.dispose();
            }

            requestAnimationFrame(detectFace);
        }

        detectFace();
    }

    runFaceDetection();
</script>
</body>
</html>
